<p id="notice"><%= notice %></p>

<%= link_to 'Index', forecast_snapshots_path %> |
<%= link_to 'Charts', forecast_snapshot_path(@forecast_snapshot) %> |
<% if current_user.admin_user? %>
  <%= link_to 'CSV', { action: :show, format: :csv, id: @forecast_snapshot } %> |
  <%= link_to 'Edit', edit_forecast_snapshot_path(@forecast_snapshot) %> |
  <%= link_to 'Dup', { action: :duplicate, id: @forecast_snapshot }  %> |
  <%= link_to 'Destroy', @forecast_snapshot, method: :delete,
                  data: { confirm: "Destroy #{@forecast_snapshot.name}, version #{@forecast_snapshot.version}: Are you sure??" } %> |
<% end %>
<%= form_with model: @forecast_snapshot, url: { action: :table }, method: :post, html: { style: 'display:inline;' } %>
  <%= raw generate_date_range_controls(@t_start, @t_end) %>
  <%= submit_tag 'Show' %>
</form>

<h2 class="snapshot-table-title"><%= @forecast_snapshot.name+' ('+@forecast_snapshot.version+')' %></h2>
<p>Last update: <%= @forecast_snapshot.updated_at.strftime('%m/%d/%Y') %></p>

<table class="snapshot-table">
  <tr>
    <th class="header-col"> &nbsp; </th>
    <% is_quarterly = @all_dates.any? {|s| s =~ /-(04|07|10)-/ } %>
    <% @all_dates[@t_start..@t_end].each do |date| %>
        <th><%= is_quarterly ? date_to_qspec(date) : date[0..3] %></th>
    <% end %>
  </tr>
  <% @tsd_files[0].get_all_series.each do |s| %>
    <% decimals = (s[:udaman_series].decimals || 1) rescue 1 %>
    <tr>
      <%
        fullname = Series.build_name_two(s[:name], s[:frequency])
        display_name = @forecast_snapshot.retrieve_name(fullname) + ' (' + fullname + ')'
      %>
      <td class="header-col series-title" title="<%= display_name %>"><%= display_name %></td>
      <% @all_dates[@t_start..@t_end].each do |date| %>
        <td class="series-data"><%= number_with_precision(s[:data_hash][date], precision: decimals, delimiter: ',') %></td>
      <% end %>
    </tr>
    <tr>
       <td class="header-col change"> &nbsp; % Change</td>
      <% @all_dates[@t_start..@t_end].each do |date| %>
          <td class="change-data"><%= number_with_precision(s[:yoy_hash][date], precision: decimals, delimiter: ',') %></td>
      <% end %>
    </tr>
  <% end %>
</table>

<div class="table-note">
  <p>Note: <%= @forecast_snapshot[:comments].to_s %></p>
</div>
<script language="JavaScript">
<% if @range_user_chosen %>
  storeFSrange(<%= @forecast_snapshot.id %>, @t_start, @t_end);
<% else %>
  replayFSrange(<%= @forecast_snapshot.id %>);
<% end %>
</script>
